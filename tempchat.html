<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header .controls {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 80%;
            animation: fadeInUp 0.5s ease;
        }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 20px 20px 5px 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .message.assistant {
            align-self: flex-start;
            background: rgba(248, 249, 250, 0.9);
            color: #2c3e50;
            padding: 20px;
            border-radius: 20px 20px 20px 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #3498db;
        }

        .message-content {
            line-height: 1.6;
        }

        .message-content h1, .message-content h2, .message-content h3 {
            margin: 15px 0 10px 0;
            color: #2c3e50;
        }

        .message-content p {
            margin: 10px 0;
        }

        .message-content ul, .message-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 5px 0;
        }

        .message-content pre {
            background: #2d3748;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            overflow-x: auto;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .input-container {
            padding: 30px;
            background: rgba(248, 249, 250, 0.9);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        #messageInput {
            width: 100%;
            min-height: 50px;
            max-height: 120px;
            padding: 15px 50px 15px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 16px;
            font-family: inherit;
            resize: none;
            background: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        #messageInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .send-button:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: translateY(-50%) scale(1);
            box-shadow: none;
        }

        .typing-indicator {
            display: none;
            align-self: flex-start;
            background: rgba(248, 249, 250, 0.9);
            padding: 15px 20px;
            border-radius: 20px 20px 20px 5px;
            color: #666;
            animation: pulse 1.5s infinite;
        }

        .typing-dots {
            display: inline-flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        .error-message {
            background: #fee;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #fed7d7;
            margin: 10px 0;
        }

        .model-selector {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            outline: none;
        }

        .model-selector option {
            background: #2c3e50;
            color: white;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-online {
            background: #4ade80;
        }

        .status-offline {
            background: #ef4444;
        }

        .status-warning {
            background: #f59e0b;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .chat-container {
                height: 95vh;
                border-radius: 15px;
            }
            
            .header {
                padding: 15px 20px;
            }
            
            .header h1 {
                font-size: 1.4em;
            }
            
            .chat-messages {
                padding: 20px 15px;
            }
            
            .message {
                max-width: 95%;
            }
            
            .input-container {
                padding: 20px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <h1>ðŸ¤– AI Chat Assistant</h1>
            <div class="controls">
                <select id="modelSelector" class="model-selector">
                    <option value="gpt-4">GPT-4</option>
                    <option value="gpt-4o">GPT-4o</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    <option value="claude-3-haiku">Claude 3 Haiku</option>
                    <option value="deepinfra/meta-llama/Meta-Llama-3-70B-Instruct">DeepInfra Llama 3 70B</option>
                    <option value="deepinfra/mistralai/Mixtral-8x7B-Instruct-v0.1">DeepInfra Mixtral 8x7B</option>
                </select>
                <div class="status-indicator" id="statusIndicator">
                    <div class="status-dot status-warning"></div>
                    <span id="statusText">Initializing...</span>
                </div>
                <button class="control-btn" onclick="loadAvailableModels()" title="Refresh Models">ðŸ”„</button>
                <button class="control-btn" onclick="clearChat()">Clear Chat</button>
                <button class="control-btn" onclick="exportChat()">Export</button>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message assistant">
                <div class="message-content">
                    <p>Hello! I'm your AI assistant. I'm here to help you with questions, creative tasks, analysis, coding, and much more. What would you like to explore today?</p>
                </div>
            </div>
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
            <span>AI is thinking</span>
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="input-container">
            <div class="input-wrapper">
                <textarea 
                    id="messageInput" 
                    placeholder="Type your message here... (Shift+Enter for new line)"
                    rows="1"
                ></textarea>
                <button class="send-button" id="sendButton" onclick="sendMessage()">
                    âž¤
                </button>
            </div>
        </div>
    </div>

    <script>
        let conversationHistory = [];
        let isTyping = false;
        let client;
        let chatMessages, messageInput, sendButton, typingIndicator, modelSelector, statusIndicator, statusText;

        // Initialize the app
        async function initializeApp() {
            try {
                // Import the client with proper provider support
                let Client, PollinationsAI, DeepInfra, Together, Puter, HuggingFace;
                try {
                    const module = await import('https://g4f.dev/dist/js/client.js');
                    Client = module.Client;
                    PollinationsAI = module.PollinationsAI;
                    DeepInfra = module.DeepInfra;
                    Together = module.Together;
                    Puter = module.Puter;
                    HuggingFace = module.HuggingFace;
                    console.log('GPT4Free providers imported:', { Client, PollinationsAI, DeepInfra, Together, Puter, HuggingFace });
                } catch (importError) {
                    console.error('Import error:', importError);
                    throw new Error('Failed to import GPT4Free client');
                }

                // Create client using proper GPT4Free providers
                console.log('Creating GPT4Free client...');
                
                // Try different providers in order of preference
                try {
                    // Try Puter first (best model selection - 87 models)
                    if (Puter) {
                        client = new Puter();
                        console.log('Client created with Puter provider');
                    } else if (DeepInfra) {
                        client = new DeepInfra({ apiKey: 'optional' });
                        console.log('Client created with DeepInfra provider');
                    } else if (PollinationsAI) {
                        client = new PollinationsAI({ apiKey: 'optional' });
                        console.log('Client created with PollinationsAI provider');
                    } else if (Client) {
                        // Fallback to generic client with local GPT4Free instance
                        client = new Client({
                            baseUrl: 'https://g4f.dev/v1',
                            apiKey: 'free'
                        });
                        console.log('Client created with generic Client provider');
                    } else {
                        throw new Error('No valid providers available');
                    }
                } catch (error) {
                    console.error('Failed to create client with any provider:', error);
                    throw error;
                }
                
                console.log('Client created successfully:', client);

                // Get DOM elements
                chatMessages = document.getElementById('chatMessages');
                messageInput = document.getElementById('messageInput');
                sendButton = document.getElementById('sendButton');
                typingIndicator = document.getElementById('typingIndicator');
                modelSelector = document.getElementById('modelSelector');
                statusIndicator = document.getElementById('statusIndicator');
                statusText = document.getElementById('statusText');

                // Verify all elements are found
                if (!chatMessages || !messageInput || !sendButton || !typingIndicator || !modelSelector) {
                    throw new Error('Some DOM elements could not be found');
                }

                // Configure marked for better markdown rendering
                marked.setOptions({
                    highlight: function(code, language) {
                        if (language && hljs.getLanguage(language)) {
                            return hljs.highlight(code, { language }).value;
                        } else {
                            return hljs.highlightAuto(code).value;
                        }
                    },
                    breaks: true,
                    gfm: true
                });

                // Setup event listeners
                setupEventListeners();

                // Update status to online
                updateStatus('online', 'Service Ready');

                // Load available models from server
                await loadAvailableModels();

                console.log('App initialized successfully');
            } catch (error) {
                console.error('Failed to initialize app:', error);
                
                // Create a fallback mock client for testing
                console.log('Creating fallback mock client...');
                client = {
                    chat: {
                        completions: {
                            create: async (params) => {
                                // Mock response for testing
                                return {
                                    choices: [{
                                        message: {
                                            content: `Mock response for model: ${params.model}\n\nYour message: "${params.messages[params.messages.length - 1].content}"\n\nThis is a fallback response since the GPT4Free client failed to initialize. Please check your internet connection and try refreshing the page.`
                                        }
                                    }]
                                };
                            }
                        }
                    }
                };
                
                // Get DOM elements even if client failed
                chatMessages = document.getElementById('chatMessages');
                messageInput = document.getElementById('messageInput');
                sendButton = document.getElementById('sendButton');
                typingIndicator = document.getElementById('typingIndicator');
                modelSelector = document.getElementById('modelSelector');
                statusIndicator = document.getElementById('statusIndicator');
                statusText = document.getElementById('statusText');
                
                // Setup event listeners
                if (messageInput && sendButton) {
                    setupEventListeners();
                }
                
                // Update status to offline
                updateStatus('offline', 'Fallback Mode');

                // Show warning message
                if (chatMessages) {
                    addMessage(`âš ï¸ GPT4Free client failed to initialize. Using fallback mode for testing. Error: ${error.message}`, 'assistant', true);
                } else {
                    alert(`GPT4Free client failed to initialize: ${error.message}. Using fallback mode.`);
                }
            }
        }

        function setupEventListeners() {
            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = '50px';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Handle Enter key
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Focus input
            messageInput.focus();
        }

        // Global functions
        async function sendMessage() {
            // Check if app is initialized
            if (!client || !messageInput || !modelSelector) {
                addMessage('Please wait for the application to initialize.', 'assistant', true);
                return;
            }

            const message = messageInput.value.trim();
            if (!message || isTyping) return;

            // Add user message
            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });
            
            // Clear input
            messageInput.value = '';
            messageInput.style.height = '50px';
            
            // Show typing indicator
            showTyping();
            
            try {
                const selectedModel = modelSelector.value;
                console.log('Sending request with model:', selectedModel);
                
                // Prepare request parameters
                const requestParams = {
                    model: selectedModel,
                    messages: conversationHistory,
                    max_tokens: 2000
                };

                // Only add temperature for models that support it
                // Some models like GPT-5 variants and Claude models only support default temperature (1)
                const modelsWithoutCustomTemp = [
                    'gpt-5', 'gpt-5-2025', 'gpt-5-2025-08-07', 'gpt-5-nano',
                    'claude-opus', 'claude-opus-4', 'claude-opus-4-latest', 'claude-opus-4-1',
                    'claude-sonnet', 'claude-sonnet-3', 'claude-sonnet-3.5', 'claude-3.5-sonnet'
                ];
                
                if (!modelsWithoutCustomTemp.some(model => selectedModel.toLowerCase().includes(model.toLowerCase()))) {
                    requestParams.temperature = 0.7;
                }

                console.log('Request parameters:', requestParams);

                // Try with a timeout and retry mechanism
                const result = await Promise.race([
                    client.chat.completions.create(requestParams),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Request timeout after 30 seconds')), 30000)
                    )
                ]);
                
                // Handle different response formats
                let aiResponse = '';
                console.log('Raw API response:', result);
                console.log('Response keys:', Object.keys(result));
                console.log('Has choices:', !!result.choices);
                console.log('Has message:', !!result.message);
                console.log('Has content:', !!result.content);
                
                if (result.choices && result.choices[0] && result.choices[0].message) {
                    console.log('Using choices path');
                    const content = result.choices[0].message.content;
                    console.log('Choices content:', content);
                    console.log('Is choices content array:', Array.isArray(content));
                    
                    if (Array.isArray(content)) {
                        // Extract text from content array (Claude format)
                        aiResponse = content
                            .filter(item => item.type === 'text' || item.text)
                            .map(item => item.text || item.content || item)
                            .join('\n');
                    } else {
                        aiResponse = content;
                    }
                } else if (result.message && result.message.content) {
                    console.log('Using message.content path');
                    // Handle Claude-style responses with nested content
                    console.log('Message content:', result.message.content);
                    console.log('Is array:', Array.isArray(result.message.content));
                    
                    if (Array.isArray(result.message.content)) {
                        console.log('Content array items:', result.message.content);
                        // Extract text from content array
                        const textItems = result.message.content
                            .filter(item => {
                                console.log('Filtering item:', item, 'type:', item?.type, 'text:', item?.text);
                                return item.type === 'text' || item.text || typeof item === 'string';
                            })
                            .map(item => {
                                console.log('Mapping item:', item);
                                if (typeof item === 'string') return item;
                                return item.text || item.content || item;
                            });
                        
                        console.log('Text items:', textItems);
                        aiResponse = textItems.join('\n');
                    } else {
                        aiResponse = result.message.content;
                    }
                } else if (result.content) {
                    console.log('Using content path');
                    aiResponse = result.content;
                } else if (result.message) {
                    console.log('Using message path');
                    aiResponse = result.message;
                } else if (result.text) {
                    aiResponse = result.text;
                } else if (result.response) {
                    aiResponse = result.response;
                } else if (result.answer) {
                    aiResponse = result.answer;
                } else if (typeof result === 'string') {
                    aiResponse = result;
                } else if (typeof result === 'object') {
                    // Try to extract text from object response
                    if (result.data && result.data.content) {
                        aiResponse = result.data.content;
                    } else if (result.data && result.data.text) {
                        aiResponse = result.data.text;
                    } else if (result.data && result.data.message) {
                        aiResponse = result.data.message;
                    } else {
                        // Last resort: stringify the object for debugging
                        aiResponse = `Received object response: ${JSON.stringify(result, null, 2)}`;
                    }
                } else {
                    aiResponse = 'Received response but could not extract content';
                }
                
                console.log('Extracted response:', aiResponse);
                
                conversationHistory.push({ role: 'assistant', content: aiResponse });
                
                hideTyping();
                addMessage(aiResponse, 'assistant');
                
            } catch (error) {
                hideTyping();
                console.error('API Error:', error);
                
                // Handle different error formats
                let errorMessage = '';
                let isServerError = false;
                
                if (error && typeof error === 'object') {
                    if (error.message) {
                        errorMessage = error.message;
                        isServerError = error.message.includes('500') || 
                                      error.message.includes('502') || 
                                      error.message.includes('503') || 
                                      error.message.includes('504');
                    } else if (error.error && error.error.message) {
                        errorMessage = error.error.message;
                    } else if (error.success === false && error.error) {
                        errorMessage = error.error.message || 'API request failed';
                    } else {
                        errorMessage = 'Unknown error occurred';
                    }
                } else if (typeof error === 'string') {
                    errorMessage = error;
                } else {
                    errorMessage = 'An unexpected error occurred';
                }
                
                if (isServerError) {
                    updateStatus('warning', 'Service Issues');
                    addMessage(`ðŸš¨ The AI service is currently experiencing issues (Server Error). This might be temporary. Please try again in a few minutes, or try a different model.`, 'assistant', true);
                } else {
                    updateStatus('warning', 'Connection Error');
                    addMessage(`Sorry, I encountered an error: ${errorMessage}. Please try again.`, 'assistant', true);
                }
                
                // Try to provide a helpful response anyway
                setTimeout(() => {
                    addMessage(`ðŸ’¡ **Troubleshooting Tips:**\n\n1. **Try a different model** - Switch between GPT-4, GPT-4o, or GPT-3.5 Turbo\n2. **Check your internet connection**\n3. **Wait a few minutes** - The service might be temporarily overloaded\n4. **Refresh the page** - This will reinitialize the connection\n\n*The GPT4Free service is community-maintained and may experience occasional downtime.*`, 'assistant');
                }, 1000);
            }
        }

        function clearChat() {
            if (!chatMessages) return;

            if (confirm('Are you sure you want to clear the chat history?')) {
                conversationHistory = [];
                chatMessages.innerHTML = `
                    <div class="message assistant">
                        <div class="message-content">
                            <p>Hello! I'm your AI assistant. I'm here to help you with questions, creative tasks, analysis, coding, and much more. What would you like to explore today?</p>
                        </div>
                    </div>
                `;
            }
        }

        function exportChat() {
            if (!conversationHistory || conversationHistory.length === 0) {
                alert('No chat history to export.');
                return;
            }

            const chatText = conversationHistory
                .map(msg => `${msg.role.toUpperCase()}: ${msg.content}`)
                .join('\n\n');

            const blob = new Blob([chatText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-export-${new Date().toISOString().slice(0, 19)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function addMessage(content, sender, isError = false) {
            if (!chatMessages) {
                console.error('chatMessages element not found');
                return;
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (isError) {
                contentDiv.innerHTML = `<div class="error-message">${content}</div>`;
            } else if (sender === 'assistant') {
                // Render markdown for assistant messages
                try {
                    // Handle different content types
                    let contentToRender = content;
                    if (Array.isArray(content)) {
                        contentToRender = content.join('\n');
                    } else if (typeof content !== 'string') {
                        contentToRender = String(content);
                    }
                    contentDiv.innerHTML = marked.parse(contentToRender);
                } catch (error) {
                    console.error('Markdown parsing error:', error);
                    // Fallback to plain text
                    let fallbackContent = content;
                    if (Array.isArray(content)) {
                        fallbackContent = content.join('\n');
                    }
                    contentDiv.textContent = fallbackContent;
                }
            } else {
                // Plain text for user messages
                contentDiv.textContent = content;
            }

            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTyping() {
            if (!sendButton || !typingIndicator || !chatMessages) return;

            isTyping = true;
            sendButton.disabled = true;
            typingIndicator.style.display = 'block';
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTyping() {
            if (!sendButton || !typingIndicator) return;

            isTyping = false;
            sendButton.disabled = false;
            typingIndicator.style.display = 'none';
        }

        function updateStatus(status, text) {
            if (!statusIndicator || !statusText) return;

            const statusDot = statusIndicator.querySelector('.status-dot');
            if (statusDot) {
                // Remove all status classes
                statusDot.classList.remove('status-online', 'status-offline', 'status-warning');
                
                // Add the appropriate class
                switch (status) {
                    case 'online':
                        statusDot.classList.add('status-online');
                        break;
                    case 'offline':
                        statusDot.classList.add('status-offline');
                        break;
                    case 'warning':
                        statusDot.classList.add('status-warning');
                        break;
                }
            }
            
            statusText.textContent = text;
        }

        async function loadAvailableModels() {
            if (!client || !modelSelector) return;

            try {
                console.log('Loading available models from server...');
                updateStatus('warning', 'Loading Models...');

                // Use the proper GPT4Free client method
                let models = [];
                
                try {
                    // Use the documented models.list() method
                    models = await client.models.list();
                    console.log('Models from client.models.list():', models);
                } catch (e) {
                    console.log('client.models.list() failed:', e);
                    
                    // Fallback: try other possible methods
                    if (client.models && typeof client.models === 'function') {
                        try {
                            models = await client.models();
                            console.log('Models from client.models():', models);
                        } catch (e2) {
                            console.log('client.models() also failed:', e2);
                        }
                    }
                }

                // If we got models, update the dropdown
                if (models && models.length > 0) {
                    updateModelDropdown(models);
                    updateStatus('online', 'Service Ready');
                    console.log('Successfully loaded', models.length, 'models');
                } else {
                    // Fallback to default models
                    console.log('No models found, using default models');
                    updateStatus('warning', 'Using Default Models');
                }

            } catch (error) {
                console.error('Error loading models:', error);
                updateStatus('warning', 'Using Default Models');
            }
        }

        function updateModelDropdown(models) {
            if (!modelSelector) return;

            // Clear existing options
            modelSelector.innerHTML = '';

            // Add models to dropdown
            models.forEach(model => {
                const option = document.createElement('option');
                
                // Handle different model data formats
                let modelId, modelName;
                if (typeof model === 'string') {
                    modelId = model;
                    modelName = model;
                } else if (model.id) {
                    modelId = model.id;
                    modelName = model.name || model.id;
                } else if (model.model) {
                    modelId = model.model;
                    modelName = model.name || model.model;
                } else {
                    modelId = model;
                    modelName = model;
                }

                option.value = modelId;
                option.textContent = modelName;
                modelSelector.appendChild(option);
            });

            // Add a separator and default models as fallback
            const separator = document.createElement('option');
            separator.disabled = true;
            separator.textContent = '--- Default Models ---';
            modelSelector.appendChild(separator);

            // Add some common default models including DeepInfra-specific ones
            const defaultModels = [
                { id: 'gpt-4.1', name: 'GPT-4.1' },
                { id: 'gpt-4.1-mini', name: 'GPT-4.1 Mini' },
                { id: 'deepseek-v3', name: 'DeepSeek V3' },
                { id: 'gpt-4o', name: 'GPT-4o' },
                { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo' },
                // DeepInfra specific models
                { id: 'deepinfra/meta-llama/Meta-Llama-3-70B-Instruct', name: 'DeepInfra Llama 3 70B' },
                { id: 'deepinfra/mistralai/Mixtral-8x7B-Instruct-v0.1', name: 'DeepInfra Mixtral 8x7B' },
                { id: 'deepinfra/microsoft/WizardLM-2-8x22B', name: 'DeepInfra WizardLM 2 8x22B' },
                { id: 'deepinfra/codellama/CodeLlama-70B-Instruct-hf', name: 'DeepInfra Code Llama 70B' }
            ];

            defaultModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name;
                modelSelector.appendChild(option);
            });

            // Select the first model
            if (modelSelector.options.length > 0) {
                modelSelector.selectedIndex = 0;
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>