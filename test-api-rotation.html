<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Key Rotation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .log {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>API Key Rotation Test</h1>
        <p>This test will verify that the API key rotation mechanism is working correctly when auth errors occur.</p>
        
        <div>
            <button onclick="testTokenRotation()">Test API Key Rotation (ChatGPT)</button>
            <button onclick="testStreaming()">Test Streaming (Gemini)</button>
            <button onclick="clearLogs()">Clear Logs</button>
            <button onclick="showTokenInfo()">Show Token Info</button>
        </div>
        
        <div id="status" class="status info">Ready to test...</div>
        
        <div class="log" id="logs">Console logs will appear here...\n</div>
    </div>

    <!-- Include the necessary scripts -->
    <script src="js/local-server-provider.js"></script>
    <script>
        let localServerProvider = null;
        let originalConsoleLog = console.log;
        let originalConsoleError = console.error;
        let originalConsoleWarn = console.warn;
        
        // Override console methods to capture logs
        function setupLogCapture() {
            console.log = function(...args) {
                originalConsoleLog.apply(console, args);
                addLog('LOG', args.join(' '));
            };
            
            console.error = function(...args) {
                originalConsoleError.apply(console, args);
                addLog('ERROR', args.join(' '));
            };
            
            console.warn = function(...args) {
                originalConsoleWarn.apply(console, args);
                addLog('WARN', args.join(' '));
            };
        }
        
        function addLog(type, message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${type}] ${message}\n`;
            logs.textContent += logEntry;
            logs.scrollTop = logs.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function clearLogs() {
            document.getElementById('logs').textContent = 'Console logs cleared...\n';
            updateStatus('Logs cleared', 'info');
        }
        
        async function showTokenInfo() {
            if (!localServerProvider) {
                updateStatus('LocalServerProvider not initialized', 'error');
                return;
            }
            
            addLog('INFO', `Total tokens loaded: ${localServerProvider.validTokens.length}`);
            addLog('INFO', `Current token index: ${localServerProvider.currentTokenIndex + 1}`);
            addLog('INFO', `Current token: ${localServerProvider.authToken.substring(0, 30)}...`);
            
            updateStatus('Token info displayed in logs', 'info');
        }
        
        async function testTokenRotation() {
            updateStatus('Initializing test...', 'info');
            
            try {
                // Initialize the provider
                localServerProvider = new LocalServerProvider();
                await localServerProvider.initializeTokens();
                
                addLog('INFO', `Initialized with ${localServerProvider.validTokens.length} tokens`);
                addLog('INFO', `Starting with token ${localServerProvider.currentTokenIndex + 1}`);
                
                // Test sending a message to ChatGPT (which requires auth)
                updateStatus('Testing API call with current token...', 'info');
                
                const testMessages = [
                    { role: 'user', content: 'Hello, this is a test message for API key rotation.' }
                ];
                
                let chunkCount = 0;
                let hasError = false;
                
                await localServerProvider.sendMessage(
                    'chatgpt',
                    testMessages,
                    // onChunk
                    (chunk, fullText) => {
                        chunkCount++;
                        addLog('CHUNK', `Received chunk ${chunkCount}: "${chunk}" (Total: "${fullText}")`);
                        
                        // Update status to show streaming is working
                        updateStatus(`Streaming... Received ${chunkCount} chunks so far`, 'info');
                    },
                    // onComplete
                    (result) => {
                        addLog('SUCCESS', `Request completed successfully! Full response: "${result.text}"`);
                        updateStatus(`Test completed successfully! Received ${chunkCount} chunks.`, 'success');
                    },
                    // onError
                    (error) => {
                        hasError = true;
                        addLog('ERROR', `Request failed: ${error.message}`);
                        
                        if (error.needsTokenRotation) {
                            addLog('INFO', 'Token rotation was triggered by auth error');
                            updateStatus('Auth error detected - token rotation should have occurred', 'error');
                        } else {
                            updateStatus('Request failed with non-auth error', 'error');
                        }
                    }
                );
                
                // Wait a moment for any async operations
                setTimeout(() => {
                    if (!hasError) {
                        addLog('INFO', 'Test completed without errors - this might mean the current token is working');
                        addLog('INFO', `Final token index: ${localServerProvider.currentTokenIndex + 1}`);
                    }
                }, 2000);
                
            } catch (error) {
                addLog('ERROR', `Test initialization failed: ${error.message}`);
                updateStatus('Test failed to initialize', 'error');
            }
        }
        
        async function testStreaming() {
            updateStatus('Testing streaming with Gemini...', 'info');
            
            try {
                // Initialize the provider
                if (!localServerProvider) {
                    localServerProvider = new LocalServerProvider();
                    await localServerProvider.initializeTokens();
                }
                
                const testMessages = [
                    { role: 'user', content: 'Hello! Please write a short story about a robot learning to paint. Make it about 3-4 sentences long.' }
                ];
                
                let chunkCount = 0;
                let hasError = false;
                let fullResponse = '';
                
                addLog('INFO', 'Testing streaming with Gemini (Pollinations) - should show real-time chunks with improved UI responsiveness');
                
                await localServerProvider.sendMessage(
                    'gemini',
                    testMessages,
                    // onChunk
                    (chunk, fullText) => {
                        chunkCount++;
                        fullResponse = fullText;
                        addLog('CHUNK', `Chunk ${chunkCount}: "${chunk}"`);
                        addLog('FULL', `Full text so far: "${fullText}"`);
                        updateStatus(`Streaming... ${chunkCount} chunks received`, 'info');
                    },
                    // onComplete
                    (result) => {
                        addLog('SUCCESS', `Streaming completed! Total chunks: ${chunkCount}`);
                        addLog('SUCCESS', `Final response: "${result.text}"`);
                        updateStatus(`Streaming test completed! ${chunkCount} chunks received.`, 'success');
                    },
                    // onError
                    (error) => {
                        hasError = true;
                        addLog('ERROR', `Streaming failed: ${error.message}`);
                        updateStatus('Streaming test failed', 'error');
                    }
                );
                
            } catch (error) {
                addLog('ERROR', `Streaming test initialization failed: ${error.message}`);
                updateStatus('Streaming test failed to initialize', 'error');
            }
        }
        
        // Initialize log capture when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setupLogCapture();
            addLog('INFO', 'API Key Rotation Test Page Loaded');
            addLog('INFO', 'Click "Test API Key Rotation" to test token rotation');
            addLog('INFO', 'Click "Test Streaming" to test streaming functionality');
        });
    </script>
</body>
</html>
